name: Release Chart

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Chart & app version (e.g. 1.2.3)"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Generate GitHub App JWT using OpenSSL
      # ---------------------------
      - name: Generate GitHub App JWT
        id: jwt
        run: |
          header=$(echo -n '{"alg":"RS256","typ":"JWT"}' | openssl base64 -A | tr '+/' '-_' | tr -d '=')

          now=$(date +%s)
          iat=$((now - 60))
          exp=$((now + 600))

          payload=$(echo -n "{\"iat\":$iat,\"exp\":$exp,\"iss\":${{ secrets.GH_APP_ID }} }" \
            | openssl base64 -A | tr '+/' '-_' | tr -d '=')

          unsigned="${header}.${payload}"

          signature=$(echo -n "$unsigned" \
            | openssl dgst -sha256 -sign <(echo "${{ secrets.GH_APP_PRIVATE_KEY }}") \
            | openssl base64 -A | tr '+/' '-_' | tr -d '=')

          echo "token=${unsigned}.${signature}" >> $GITHUB_OUTPUT

      # ---------------------------
      # Exchange JWT for Installation Token
      # ---------------------------
      - name: Get Installation Token
        id: app_token
        run: |
          token=$(curl -sX POST \
            -H "Authorization: Bearer ${{ steps.jwt.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/app/installations/${{ secrets.GH_APP_INSTALLATION_ID }}/access_tokens \
            | jq -r '.token')

          echo "token=$token" >> $GITHUB_OUTPUT

      # ---------------------------
      # Checkout repo
      # ---------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app_token.outputs.token }}

      # ---------------------------
      # Install Helm
      # ---------------------------
      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # ---------------------------
      # Update Helm dependencies
      # ---------------------------
      - name: Update Helm dependencies
        run: |
          helm dependency update charts/flask-app

      # ---------------------------
      # Package Helm chart
      # ---------------------------
      - name: Package Helm chart
        run: |
          VERSION="${{ github.event.inputs.version }}"

          helm package charts/flask-app \
            --app-version "$VERSION" \
            --version "$VERSION" \
            -d packaged/

      # ---------------------------
      # GHCR login
      # ---------------------------
      - name: GHCR Login
        run: |
          echo "${{ secrets.GH_HELM_CHARTS }}" | \
            helm registry login ghcr.io \
              --username x-access-token \
              --password-stdin

      # ---------------------------
      # Push Helm Chart to GHCR (OCI)
      # ---------------------------
      - name: Push Helm chart to GHCR
        run: |
          CHART="flask-app"
          VERSION="${{ github.event.inputs.version }}"

          OCI_URL="ghcr.io/igorsilva-dev/${CHART}"

          helm push packaged/${CHART}-${VERSION}.tgz "oci://${OCI_URL}"
