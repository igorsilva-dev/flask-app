name: Release Chart

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Chart & app version (e.g. 1.2.3)"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      #  Authenticate as GitHub App
      # ---------------------------
      - name: Generate GitHub App Token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          installation_id: ${{ secrets.GH_APP_INSTALLATION_ID }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      # ---------------------------
      # Install Helm CLI
      # ---------------------------
      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # ---------------------------
      #  Set chart version + appVersion dynamically
      # ---------------------------
      - name: Package Helm chart with version overrides
        run: |
          APP_VERSION="${{ github.event.inputs.version }}"
          CHART_VERSION="${{ github.event.inputs.version }}"

          echo "Packaging chart with version=$CHART_VERSION appVersion=$APP_VERSION"

          helm package charts/flask-app \
            --app-version "$APP_VERSION" \
            --version "$CHART_VERSION" \
            -d packaged/

      # ---------------------------
      # Authenticate to GHCR using GitHub App token
      # ---------------------------
      - name: GHCR Login
        run: |
          echo ${{ steps.app-token.outputs.token }} | \
            helm registry login ghcr.io \
              --username x-access-token \
              --password-stdin

      # ---------------------------
      #  Push packaged chart to GHCR (OCI)
      # ---------------------------
      - name: Push Helm chart to GHCR
        run: |
          CHART="flask-app"
          VERSION="${{ github.event.inputs.version }}"
          
          # Build OCI URL: ghcr.io/<OWNER>/<chart>
          OCI_URL="ghcr.io/igorsilva-dev/${CHART}"

          echo "Pushing chart to $OCI_URL:$VERSION"

          helm push packaged/${CHART}-${VERSION}.tgz "oci://${OCI_URL}"
